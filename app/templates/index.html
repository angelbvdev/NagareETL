<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NagareETL | Interactive Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a', 
                        card: '#1e293b', 
                        bronze: '#cd7f32', 
                        silver: '#c0c0c0', 
                        gold: '#ffd700', 
                        accent: '#38bdf8' 
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* --- ESTILOS DEL TUTORIAL --- */
        .tutorial-highlight {
            position: relative;
            z-index: 60 !important; /* El elemento resaltado sube al nivel 60 */
            box-shadow: 0 0 0 4px #38bdf8, 0 0 50px rgba(56, 189, 248, 0.5);
            transition: all 0.3s ease;
            background-color: #1e293b; 
            pointer-events: auto; 
            border-radius: 0.5rem;
        }

        #tutorial-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="bg-dark text-gray-100 font-sans min-h-screen flex flex-col relative overflow-hidden">

    <div id="tutorial-overlay" class="fixed inset-0 z-40 hidden transition-opacity duration-300"></div>

    <div id="tutorial-box" class="fixed bottom-10 right-10 z-[100] bg-card border-l-4 border-accent p-6 rounded-r-lg shadow-2xl max-w-md hidden fade-in">
        <div class="flex justify-between items-start mb-2">
            <h4 class="text-accent font-bold text-lg" id="tut-title">Título</h4>
            <button onclick="endTutorial()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
        </div>
        <p class="text-gray-300 text-sm mb-4 leading-relaxed" id="tut-desc">Descripción...</p>
        <div class="flex justify-between items-center">
            <span class="text-xs text-gray-500" id="tut-step-count">Paso 1/5</span>
            <button id="tut-next-btn" onclick="nextStep()" class="bg-accent text-dark font-bold px-4 py-1 rounded text-sm hover:bg-cyan-400 transition">
                Siguiente <i class="fa-solid fa-arrow-right ml-1"></i>
            </button>
        </div>
    </div>

    <nav class="border-b border-gray-700 bg-card p-4 shadow-lg z-30 relative">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-water text-accent text-2xl"></i>
                <h1 class="text-2xl font-bold tracking-wider">NAGARE<span class="text-accent">ETL</span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="startTutorial()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm border border-gray-500 transition shadow-lg hover:text-accent">
                    <i class="fa-solid fa-graduation-cap text-accent mr-2"></i> Tutorial
                </button>
                <div class="text-right text-xs text-gray-500 hidden md:block">
                    <p class="font-semibold text-accent">Sistema Activo</p>
                    <p id="clock">00:00:00</p>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-6 relative">
        
        <div class="flex justify-between items-end mb-8">
            <div id="header-area" class="p-2 rounded">
                <h2 class="text-3xl font-bold">Pipeline Overview</h2>
                <p class="text-gray-400">Panel de Control de Ingesta y Procesamiento</p>
            </div>
            <div class="space-x-2" id="controls-area">
                <button id="btn-ingest" onclick="generateData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow transition transform active:scale-95">
                    <i class="fa-solid fa-bug mr-2"></i> Ingestar Datos
                </button>
                <button id="btn-etl" onclick="runPipeline()" class="bg-accent hover:bg-cyan-600 text-dark font-bold px-4 py-2 rounded shadow transition transform active:scale-95">
                    <i class="fa-solid fa-play mr-2"></i> Ejecutar ETL
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[600px]">

            <div id="col-bronze" class="bg-card rounded-xl p-4 border-t-4 border-bronze flex flex-col shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-bronze">Bronze Layer</h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Raw / Landing</span>
                </div>
                <div id="bronze-list" class="flex-grow bg-dark rounded-lg p-4 overflow-y-auto space-y-2 border border-gray-700">
                    <p class="text-gray-600 text-center text-sm mt-10">Esperando datos...</p>
                </div>
                <div class="mt-4 text-center">
                    <span id="bronze-counter" class="text-3xl font-bold text-white">0</span>
                    <p class="text-xs text-gray-400 uppercase tracking-widest">Archivos en Cola</p>
                </div>
            </div>

            <div id="col-silver" class="bg-card rounded-xl p-4 border-t-4 border-silver flex flex-col shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-silver">Silver Layer</h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Processing Logs</span>
                </div>
                <div id="silver-terminal" class="flex-grow bg-black rounded-lg p-4 font-mono text-xs overflow-y-auto border border-gray-700 text-green-400">
                    <p class="text-gray-600">> System Ready.</p>
                </div>
            </div>

            <div id="col-gold" class="bg-card rounded-xl p-4 border-t-4 border-gold flex flex-col shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gold">Gold Layer</h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Analytics</span>
                </div>
                <div class="flex-grow bg-dark rounded-lg p-4 flex flex-col justify-end border border-gray-700 relative">
                    <div class="flex justify-around items-end h-full w-full space-x-2" id="chart-container">
                        <div class="w-full bg-gray-700 rounded-t transition-all duration-500 h-[10%]"></div>
                        <div class="w-full bg-gray-700 rounded-t transition-all duration-500 h-[20%]"></div>
                        <div class="w-full bg-accent rounded-t transition-all duration-1000 h-[5%] shadow-[0_0_10px_rgba(56,189,248,0.5)]" id="live-bar"></div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <span id="gold-total" class="text-xl font-bold text-white">$ 0.00</span>
                    <p class="text-xs text-gray-400 uppercase tracking-widest">Ventas Acumuladas</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- LOGICA DEL PIPELINE ---
        let totalSales = 0;
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

        async function generateData() {
            if(tutorialActive && currentStep !== 1) return;

            const response = await fetch('/generate', { method: 'POST' });
            const data = await response.json();
            
            const list = document.getElementById('bronze-list');
            const counter = document.getElementById('bronze-counter');
            if(list.innerText.includes('Esperando')) list.innerHTML = '';

            const borderColor = (data.data.status === 'COMPLETED') ? 'border-green-500' : 'border-red-500';
            const statusIcon = (data.data.status === 'COMPLETED') ? '<i class="fa-solid fa-check text-green-500"></i>' : '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>';

            const item = `
                <div class="bg-gray-800 p-3 rounded border-l-4 ${borderColor} flex justify-between items-center fade-in mb-2">
                    <div>
                        <p class="text-xs font-mono text-gray-300">${data.filename}</p>
                        <p class="text-[10px] text-gray-500 uppercase">${data.data.store} | $${data.data.amount}</p>
                    </div>
                    ${statusIcon}
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', item);
            counter.innerText = data.total_files;

            if(tutorialActive && currentStep === 1) {
                ingestClicks++;
                const progText = document.getElementById('ingest-progress');
                if(progText) progText.innerText = `Progreso: ${ingestClicks}/5`;

                if(ingestClicks >= 5) {
                    nextStep();
                }
            }
        }

        async function runPipeline() {
            if(tutorialActive && currentStep !== 3) return;

            const terminal = document.getElementById('silver-terminal');
            terminal.innerHTML += `<p class="text-blue-400 mb-1">> Starting ETL Job...</p>`;
            
            const response = await fetch('/run-etl', { method: 'POST' });
            const result = await response.json();

            if (result.logs) {
                for (const log of result.logs) {
                    let color = 'text-green-400';
                    if (log.includes('WARN')) color = 'text-yellow-400';
                    if (log.includes('ERROR')) color = 'text-red-400';
                    await new Promise(r => setTimeout(r, 200));
                    terminal.innerHTML += `<p class="${color} mb-1 font-mono">> ${log}</p>`;
                    terminal.scrollTop = terminal.scrollHeight;
                }
            }

            if (result.metrics) {
                if (result.metrics.sales_added > 0) {
                    totalSales += result.metrics.sales_added;
                    document.getElementById('gold-total').innerText = `$ ${totalSales.toLocaleString()}`;
                    updateChart();
                }
                document.getElementById('bronze-list').innerHTML = '<p class="text-gray-600 text-center text-sm mt-10">Procesamiento completo. Esperando nuevos datos...</p>';
                document.getElementById('bronze-counter').innerText = '0';
            }

            if(tutorialActive && currentStep === 3) nextStep();
        }

        function updateChart() {
            const bars = document.querySelectorAll('#chart-container div');
            bars.forEach(bar => {
                const randomHeight = Math.floor(Math.random() * 80) + 10;
                bar.style.height = `${randomHeight}%`;
            });
            document.getElementById('live-bar').style.height = '90%';
        }

        // --- SISTEMA DE TUTORIAL INTERACTIVO ---
        
        let tutorialActive = false;
        let currentStep = 0;
        let ingestClicks = 0;

        const steps = [
            {
                target: 'header-area',
                title: 'Bienvenido a NagareETL',
                desc: 'Esta herramienta simula un Data Pipeline moderno. Veremos cómo los datos viajan desde ser archivos "sucios" hasta estar listos para decisiones de negocio.',
                actionRequired: false
            },
            {
                target: 'col-bronze',
                title: 'Paso 1: Ingesta Masiva (Bronze)',
                desc: 'Necesitamos volumen para detectar patrones y errores. <br><br> <strong class="text-accent">TAREA:</strong> Presiona el botón rojo <b>5 VECES</b> para simular una carga de trabajo real.<br><br><span id="ingest-progress" class="bg-gray-700 px-2 py-1 rounded text-xs font-mono text-white">Progreso: 0/5</span>',
                highlightButton: 'btn-ingest',
                actionRequired: true
            },
            {
                target: 'col-bronze',
                title: 'Observación: Calidad de Datos',
                desc: '¡Excelente! Ahora tenemos un lote de datos. Fíjate que algunos archivos tienen borde <span class="text-red-400 font-bold">ROJO</span>. Estos contienen errores simulados (nulos, fechas rotas). Si no los limpiamos, corromperán nuestros reportes.',
                actionRequired: false
            },
            {
                target: 'col-silver',
                title: 'Paso 2: Procesamiento (Silver)',
                desc: 'Vamos a activar el cluster de Spark. Este proceso leerá Bronze, descartará los archivos rojos y guardará los limpios en Silver. <br><br> <strong class="text-accent">TAREA:</strong> Presiona "Ejecutar ETL" para procesar el lote.',
                highlightButton: 'btn-etl',
                actionRequired: true
            },
            {
                target: 'silver-terminal',
                title: 'Logs de Ejecución',
                desc: 'Observa la terminal. El sistema valida cada archivo. Nota los mensajes <span class="text-yellow-400">WARN</span>: el sistema está protegiendo la calidad de los datos descartando la basura automáticamente.',
                actionRequired: false
            },
            {
                target: 'col-gold',
                title: 'Paso 3: Capa Gold (Analytics)',
                desc: '¡Misión cumplida! Los datos han sido limpiados, integrados y ahora impulsan un aumento en las ventas totales. Esto simula el recorrido completo de la información, desde su recolección hasta su visualización, para apoyar la toma de mejores decisiones.',
                actionRequired: false
            }
        ];

        function startTutorial() {
            tutorialActive = true;
            currentStep = 0;
            ingestClicks = 0;
            document.getElementById('tutorial-overlay').classList.remove('hidden');
            document.getElementById('tutorial-box').classList.remove('hidden');
            showStep();
        }

        function endTutorial() {
            tutorialActive = false;
            document.getElementById('tutorial-overlay').classList.add('hidden');
            document.getElementById('tutorial-box').classList.add('hidden');
            removeHighlight();
        }

        function showStep() {
            const step = steps[currentStep];
            
            document.getElementById('tut-title').innerText = step.title;
            document.getElementById('tut-desc').innerHTML = step.desc;
            document.getElementById('tut-step-count').innerText = `Paso ${currentStep + 1}/${steps.length}`;

            const nextBtn = document.getElementById('tut-next-btn');
            if(step.actionRequired) {
                nextBtn.classList.add('hidden'); 
            } else {
                nextBtn.classList.remove('hidden');
                nextBtn.innerText = (currentStep === steps.length - 1) ? 'Finalizar' : 'Siguiente';
            }

            removeHighlight();
            const targetEl = document.getElementById(step.target);
            if(targetEl) targetEl.classList.add('tutorial-highlight');
            
            if(step.highlightButton) {
                document.getElementById(step.highlightButton).classList.add('tutorial-highlight');
            }
        }

        function nextStep() {
            if(currentStep < steps.length - 1) {
                currentStep++;
                showStep();
            } else {
                endTutorial();
            }
        }

        function removeHighlight() {
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
        }

    </script>
</body>
</html>